<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>School Funding and Poverty Analysis Dashboard</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            margin-top: 20px;
            margin-bottom: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            padding: 30px 0;
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            border-radius: 15px;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.8rem;
            font-weight: 700;
            margin-bottom: 15px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
            max-width: 800px;
            margin: 0 auto;
            line-height: 1.7;
        }

        .project-overview {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 40px;
            border-left: 5px solid #4facfe;
        }

        .project-overview h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.8rem;
        }

        .project-overview p {
            margin-bottom: 15px;
            color: #555;
            font-size: 1.1rem;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .metric-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            text-align: center;
            border-top: 4px solid #4facfe;
        }

        .metric-card h3 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }

        .metric-card .value {
            font-size: 1.8rem;
            font-weight: bold;
            color: #4facfe;
        }

        .visualization-section {
            margin: 40px 0;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e9ecef;
        }

        .section-header h2 {
            color: #2c3e50;
            font-size: 1.8rem;
            margin: 0;
        }

        .section-description {
            color: #666;
            font-size: 1rem;
            margin-bottom: 20px;
            font-style: italic;
        }

        .state-info {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid #2196f3;
        }

        .selected-state {
            font-size: 1.2rem;
            font-weight: bold;
            color: #1976d2;
        }

        svg {
            display: block;
            margin: 20px auto;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            background: white;
        }

        .tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 12px;
            border-radius: 8px;
            font-size: 12px;
            pointer-events: none;
            max-width: 250px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            z-index: 1000;
        }

        .legend {
            font-size: 11px;
            font-weight: 500;
        }

        .comparison-chart, #scatter-plot {
            margin: 20px auto;
        }

        .bar-label {
            font-size: 11px;
            font-weight: 500;
        }

        .insights-panel {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            margin-top: 40px;
        }

        .insights-panel h3 {
            margin-bottom: 20px;
            font-size: 1.6rem;
        }

        .insights-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .insight-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
        }

        .insight-item h4 {
            margin-bottom: 10px;
            color: #fff;
        }

        .insight-item p {
            opacity: 0.9;
            line-height: 1.6;
        }

        .navigation-hint {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
            color: #856404;
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                padding: 15px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .header p {
                font-size: 1rem;
            }
            
            svg {
                width: 100% !important;
                height: auto !important;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header Section -->
        <div class="header">
            <h1>School Funding & Poverty Analysis Dashboard</h1>
            <p>Exploring the relationship between educational funding, poverty rates, and resource allocation across U.S. school districts</p>
        </div>

        <!-- Project Overview -->
        <div class="project-overview">
            <h2>Project Overview</h2>
            <p>This interactive visualization examines the complex relationship between school funding, poverty rates, and educational equity across the United States. Using comprehensive data from the Urban Institute and U.S. Census Bureau, the dashboard analyzes how financial resources are distributed among school districts and their correlation with student poverty levels.</p>
            
            <p>The analysis introduces the <strong>Poverty Sensitivity Index (PSI)</strong> - a novel metric that measures how well school funding responds to student poverty levels. Higher PSI values indicate districts that receive more funding per student relative to their poverty rates, suggesting better resource allocation for high-need populations.</p>

            <div class="metrics-grid">
                <div class="metric-card">
                    <h3>School Districts Analyzed</h3>
                    <div class="value">13,000+</div>
                </div>
                <div class="metric-card">
                    <h3>Students Covered</h3>
                    <div class="value">49M+</div>
                </div>
                <div class="metric-card">
                    <h3>States Included</h3>
                    <div class="value">50</div>
                </div>
                <div class="metric-card">
                    <h3>Key Metric</h3>
                    <div class="value">PSI</div>
                </div>
            </div>
        </div>

        <!-- Navigation Hint -->
        <div class="navigation-hint">
            <strong>How to Use:</strong> Click on any state in the map below to explore district-level data. Use the scatter plot and comparison charts to analyze funding patterns and equity metrics.
        </div>

        <!-- State View -->
        <div class="visualization-section">
            <div class="section-header">
                <h2>National Overview</h2>
            </div>
            <div class="section-description">
                This choropleth map displays state-level Poverty Sensitivity Index (PSI) values. Darker colors indicate higher PSI scores, suggesting better funding allocation relative to poverty levels.
            </div>
            <svg id="state-map"></svg>
        </div>

        <!-- District View -->
        <div class="visualization-section">
            <div class="section-header">
                <h2>District Analysis</h2>
            </div>
            <div class="state-info">
                <div class="selected-state">Selected State: <span id="selected-state">Click on a state above to explore districts</span></div>
            </div>
            <div class="section-description">
                Detailed view of school districts within the selected state, colored by PSI values. Each district can be clicked for detailed comparisons.
            </div>
            <svg id="district-map" width="1200" height="800"></svg>
        </div>

        <!-- Comparison Chart -->
        <div class="visualization-section">
            <div class="section-header">
                <h2>District Performance Comparison</h2>
            </div>
            <div class="section-description">
                Compare selected district metrics against state and national averages. Click on any district in the map above to see detailed comparisons.
            </div>
            <svg id="comparison-chart" height="300"></svg>
        </div>

        <!-- Scatter Plot -->
        <div class="visualization-section">
            <div class="section-header">
                <h2>Funding vs. Poverty Relationship</h2>
            </div>
            <div class="section-description">
                This scatter plot reveals the relationship between revenue per student and poverty rates within the selected state. Each point represents a school district, colored by PSI values.
            </div>
            <svg id="scatter-plot" width="800" height="400"></svg>
        </div>

        <!-- Key Insights -->
        <div class="insights-panel">
            <h3>Key Insights & Methodology</h3>
            <div class="insights-grid">
                <div class="insight-item">
                    <h4>Poverty Sensitivity Index (PSI)</h4>
                    <p>PSI = (Revenue per Student) / (Poverty Rate). This metric helps identify districts that effectively allocate resources to high-need student populations, with higher values indicating better poverty-adjusted funding.</p>
                </div>
                <div class="insight-item">
                    <h4>Geographic Patterns</h4>
                    <p>The analysis reveals significant regional variations in funding equity, with some states showing consistently higher PSI values across districts, suggesting more equitable state-level funding formulas.</p>
                </div>
                <div class="insight-item">
                    <h4>Data Integration</h4>
                    <p>This project combines financial data from the Urban Institute's Education Finance Database with demographic data from the U.S. Census Bureau, providing a comprehensive view of educational equity.</p>
                </div>
                <div class="insight-item">
                    <h4>Policy Implications</h4>
                    <p>The findings highlight districts and states that may benefit from funding formula adjustments to better serve high-poverty student populations and improve educational equity.</p>
                </div>
            </div>
        </div>
    </div>

    <div class="tooltip" style="display: none;"></div>

    <script>
        const width = 960, height = 600;
        let nationalAverages = null;
        let stateAverages = null;
        let districtsData = null;

        const tooltip = d3.select(".tooltip");

        // State map setup
        const stateProjection = d3.geoAlbersUsa()
            .scale(1000)
            .translate([width / 2, height / 2]);

        const statePath = d3.geoPath().projection(stateProjection);
        const stateSvg = d3.select("#state-map")
            .attr("width", width)
            .attr("height", height);

        // District map setup
        const districtSvg = d3.select("#district-map");
        const scatterSvg = d3.select("#scatter-plot");

        function logDebug(message, data = null) {
            console.log(message, data);
        }

        function calculateAverages(data, metrics) {
            const averages = {};
            metrics.forEach(metric => {
                const values = data
                    .map(d => d.properties[metric])
                    .filter(val => val != null && !isNaN(val) && isFinite(val));
                averages[metric] = values.length > 0 ? d3.mean(values) : 0;
            });
            return averages;
        }

        // Load state data
        d3.json("state_FINAL.geojson")
            .then(data => {
                const states = data.features;
                
                // Filter valid PSI values for color scale
                const validPSI = states
                    .map(d => d.properties.PSI)
                    .filter(val => val != null && !isNaN(val) && isFinite(val));

                const colorScale = d3.scaleQuantile()
                    .domain(validPSI)
                    .range(["#fee5d9", "#fcbba1", "#fc9272", "#fb6a4a", "#de2d26", "#a50f15"]);

                stateSvg.selectAll("path")
                    .data(states)
                    .enter()
                    .append("path")
                    .attr("d", statePath)
                    .attr("fill", d => {
                        const psi = d.properties.PSI;
                        return (psi != null && !isNaN(psi) && isFinite(psi)) ? colorScale(psi) : "#ccc";
                    })
                    .attr("stroke", "#666")
                    .attr("stroke-width", 0.5)
                    .style("cursor", "pointer")
                    .on("mouseover", function(event, d) {
                        d3.select(this)
                            .transition()
                            .duration(200)
                            .attr("stroke-width", 2)
                            .attr("stroke", "#333");

                        tooltip
                            .style("display", "block")
                            .html(getTooltipContent(d))
                            .style("left", (event.pageX + 10) + "px")
                            .style("top", (event.pageY - 10) + "px");
                    })
                    .on("mousemove", function(event) {
                        tooltip
                            .style("left", (event.pageX + 10) + "px")
                            .style("top", (event.pageY - 10) + "px");
                    })
                    .on("mouseout", function() {
                        d3.select(this)
                            .transition()
                            .duration(200)
                            .attr("stroke-width", 0.5)
                            .attr("stroke", "#666");

                        tooltip.style("display", "none");
                    })
                    .on("click", function(event, d) {
                        if (d.properties.name) {
                            loadDistricts(d.properties.name);
                        }
                    });

                // Add state map legend
                createLegend(stateSvg, colorScale, width, height, "PSI Score");
            })
            .catch(error => {
                console.error("Error loading state data:", error);
            });

        // Load districts data
        d3.json("districts.geojson")
            .then(data => {
                districtsData = data;
                nationalAverages = calculateAverages(data.features, [
                    'Revenue per Student',
                    'PSI',
                    'Share of school-age population (ages 5-17) in poverty'
                ]);
                logDebug("Districts data loaded", { totalDistricts: districtsData.features.length });
            })
            .catch(error => {
                logDebug("Error loading districts data:", error);
            });

        function loadDistricts(stateName) {
            logDebug("Loading districts for state:", stateName);

            // Update selected state display
            document.getElementById("selected-state").textContent = stateName;

            districtSvg.selectAll("*").remove();
            scatterSvg.selectAll("*").remove();
            d3.select("#comparison-chart").selectAll("*").remove();
            tooltip.style("display", "none");

            const selectedRow = districtsData.features.find(row => row.properties["State Name"] === stateName);
            if (selectedRow) {
                const filterValue = selectedRow.properties["STATEFP"];
                const filteredDistricts = districtsData.features.filter(row => row.properties["STATEFP"] === filterValue);

                stateAverages = calculateAverages(filteredDistricts, [
                    'Revenue per Student',
                    'PSI',
                    'Share of school-age population (ages 5-17) in poverty'
                ]);

                if (filteredDistricts.length > 0) {
                    const statePSIValues = filteredDistricts
                        .map(d => d.properties["PSI"])
                        .filter(val => val != null && !isNaN(val) && isFinite(val));
                    
                    const stateColorScale = d3.scaleQuantile()
                        .domain(statePSIValues)
                        .range(["#fee5d9", "#fcbba1", "#fc9272", "#fb6a4a", "#de2d26", "#a50f15"]);

                    createDistrictMap(filteredDistricts, stateColorScale);
                    createScatterPlot(filteredDistricts, stateColorScale);
                }
            }
        }

        function createDistrictMap(filteredDistricts, colorScale) {
            const bounds = d3.geoBounds({type: "FeatureCollection", features: filteredDistricts});
            const districtProjection = d3.geoMercator().fitSize([1160, 760], {type: "FeatureCollection", features: filteredDistricts});
            const districtPath = d3.geoPath().projection(districtProjection);

            districtSvg.selectAll("path")
                .data(filteredDistricts)
                .enter()
                .append("path")
                .attr("d", districtPath)
                .attr("fill", d => {
                    const psi = d.properties["PSI"];
                    return (psi != null && !isNaN(psi) && isFinite(psi)) ? colorScale(psi) : "#ccc";
                })
                .attr("stroke", "#333")
                .attr("stroke-width", 0.3)
                .style("cursor", "pointer")
                .on("mouseover", function(event, d) {
                    d3.select(this)
                        .transition()
                        .duration(200)
                        .attr("stroke-width", 2)
                        .attr("stroke", "#000");

                    tooltip
                        .style("display", "block")
                        .html(getDistrictTooltipContent(d))
                        .style("left", (event.pageX + 10) + "px")
                        .style("top", (event.pageY - 10) + "px");
                })
                .on("mousemove", function(event) {
                    tooltip
                        .style("left", (event.pageX + 10) + "px")
                        .style("top", (event.pageY - 10) + "px");
                })
                .on("mouseout", function() {
                    d3.select(this)
                        .transition()
                        .duration(200)
                        .attr("stroke-width", 0.3)
                        .attr("stroke", "#333");

                    tooltip.style("display", "none");
                })
                .on("click", function(event, d) {
                    createComparisonChart(d, stateAverages, nationalAverages);
                });

            // Add district map legend
            createLegend(districtSvg, colorScale, 1200, 800, "PSI Score");
        }

        function createLegend(svg, colorScale, width, height, title) {
            const legendGroup = svg.append("g")
                .attr("class", "legend")
                .attr("transform", `translate(20, ${height - 80})`);

            const legendWidth = 200;
            const legendHeight = 15;

            // Create gradient
            const gradient = svg.append("defs")
                .append("linearGradient")
                .attr("id", `legend-gradient-${Math.random()}`)
                .attr("x1", "0%")
                .attr("x2", "100%")
                .attr("y1", "0%")
                .attr("y2", "0%");

            const colors = colorScale.range();
            colors.forEach((color, i) => {
                gradient.append("stop")
                    .attr("offset", `${(i / (colors.length - 1)) * 100}%`)
                    .attr("stop-color", color);
            });

            // Legend rectangle
            legendGroup.append("rect")
                .attr("width", legendWidth)
                .attr("height", legendHeight)
                .style("fill", `url(#legend-gradient-${gradient.attr("id")})`);

            // Legend title
            legendGroup.append("text")
                .attr("x", 0)
                .attr("y", -5)
                .style("font-size", "12px")
                .style("font-weight", "bold")
                .text(title);

            // Legend labels
            const quartiles = colorScale.quantiles();
            const values = [d3.min(colorScale.domain()), ...quartiles, d3.max(colorScale.domain())];
            const numTicks = 5;
            const tickPositions = d3.range(numTicks).map(i => (i * legendWidth) / (numTicks - 1));

            tickPositions.forEach((position, i) => {
                legendGroup.append("line")
                    .attr("x1", position)
                    .attr("x2", position)
                    .attr("y1", legendHeight)
                    .attr("y2", legendHeight + 5)
                    .style("stroke", "black")
                    .style("stroke-width", 1);

                legendGroup.append("text")
                    .attr("x", position)
                    .attr("y", legendHeight + 20)
                    .style("font-size", "10px")
                    .style("text-anchor", "middle")
                    .text(values[i] ? values[i].toFixed(0) : "");
            });
        }

        function createScatterPlot(filteredDistricts, colorScale) {
            const scatterMargin = { top: 20, right: 30, bottom: 50, left: 60 };
            const scatterWidth = 800 - scatterMargin.left - scatterMargin.right;
            const scatterHeight = 400 - scatterMargin.top - scatterMargin.bottom;

            scatterSvg
                .attr("width", scatterWidth + scatterMargin.left + scatterMargin.right)
                .attr("height", scatterHeight + scatterMargin.top + scatterMargin.bottom);

            scatterSvg.selectAll("*").remove();

            const scatterGroup = scatterSvg.append("g")
                .attr("transform", `translate(${scatterMargin.left},${scatterMargin.top})`);

            const validData = filteredDistricts.filter(d => {
                return d.properties &&
                    typeof d.properties["Revenue per Student"] === 'number' &&
                    typeof d.properties["Share of school-age population (ages 5-17) in poverty"] === 'number' &&
                    !isNaN(d.properties["Revenue per Student"]) &&
                    !isNaN(d.properties["Share of school-age population (ages 5-17) in poverty"]);
            });

            if (validData.length === 0) {
                console.error("No valid data for scatter plot");
                return;
            }

            const xScale = d3.scaleLinear()
                .domain(d3.extent(validData, d => d.properties["Revenue per Student"]))
                .range([0, scatterWidth])
                .nice();

            const yScale = d3.scaleLinear()
                .domain([0, 1])
                .range([scatterHeight, 0])
                .nice();

            // Add X axis
            const xAxis = scatterGroup.append("g")
                .attr("transform", `translate(0,${scatterHeight})`)
                .call(d3.axisBottom(xScale)
                    .tickFormat(d => `$${d3.format(",")(d)}`));

            xAxis.append("text")
                .attr("x", scatterWidth / 2)
                .attr("y", 40)
                .attr("fill", "black")
                .style("text-anchor", "middle")
                .style("font-size", "12px")
                .style("font-weight", "bold")
                .text("Revenue per Student ($)");

            // Add Y axis
            const yAxis = scatterGroup.append("g")
                .call(d3.axisLeft(yScale)
                    .tickFormat(d => `${(d * 100).toFixed(0)}%`));

            yAxis.append("text")
                .attr("transform", "rotate(-90)")
                .attr("y", -45)
                .attr("x", -scatterHeight / 2)
                .attr("fill", "black")
                .style("text-anchor", "middle")
                .style("font-size", "12px")
                .style("font-weight", "bold")
                .text("Share of School-age Population in Poverty");

            // Add dots
            scatterGroup.selectAll(".dot")
                .data(validData)
                .enter()
                .append("circle")
                .attr("class", "dot")
                .attr("cx", d => xScale(d.properties["Revenue per Student"]))
                .attr("cy", d => yScale(d.properties["Share of school-age population (ages 5-17) in poverty"]))
                .attr("r", 4)
                .style("fill", d => {
                    const psi = d.properties["PSI"];
                    return (psi != null && !isNaN(psi) && isFinite(psi)) ? colorScale(psi) : "#ccc";
                })
                .style("opacity", 0.7)
                .style("stroke", "#333")
                .style("stroke-width", 0.5)
                .style("cursor", "pointer")
                .on("mouseover", function(event, d) {
                    d3.select(this)
                        .transition()
                        .duration(200)
                        .attr("r", 6)
                        .style("opacity", 1);

                    tooltip
                        .style("display", "block")
                        .html(getDistrictTooltipContent(d))
                        .style("left", (event.pageX + 10) + "px")
                        .style("top", (event.pageY - 10) + "px");
                })
                .on("mousemove", function(event) {
                    tooltip
                        .style("left", (event.pageX + 10) + "px")
                        .style("top", (event.pageY - 10) + "px");
                })
                .on("mouseout", function() {
                    d3.select(this)
                        .transition()
                        .duration(200)
                        .attr("r", 4)
                        .style("opacity", 0.7);

                    tooltip.style("display", "none");
                })
                .on("click", function(event, d) {
                    createComparisonChart(d, stateAverages, nationalAverages);
                });
        }

        function createComparisonChart(districtData, stateAverages, nationalAverages) {
            const chartSvg = d3.select("#comparison-chart");
            chartSvg.selectAll("*").remove();

            const margin = { top: 20, right: 30, bottom: 40, left: 120 };
            const chartWidth = 800 - margin.left - margin.right;
            const chartHeight = 300 - margin.top - margin.bottom;

            chartSvg
                .attr("width", chartWidth + margin.left + margin.right)
                .attr("height", chartHeight + margin.top + margin.bottom);

            const chartGroup = chartSvg.append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`);

            const metrics = [
                { key: 'Revenue per Student', label: 'Revenue per Student', format: d => `${d3.format(",")(d)}` },
                { key: 'PSI', label: 'Poverty Sensitivity Index', format: d => d3.format(".1f")(d) },
                { key: 'Share of school-age population (ages 5-17) in poverty', label: 'Poverty Rate', format: d => `${(d * 100).toFixed(1)}%` }
            ];

            const districtProps = districtData.properties;
            const data = [];

            metrics.forEach(metric => {
                const districtValue = districtProps[metric.key];
                const stateValue = stateAverages[metric.key];
                const nationalValue = nationalAverages[metric.key];

                if (districtValue != null && !isNaN(districtValue)) {
                    data.push({
                        metric: metric.label,
                        district: districtValue,
                        state: stateValue || 0,
                        national: nationalValue || 0,
                        format: metric.format
                    });
                }
            });

            if (data.length === 0) return;

            const y = d3.scaleBand()
                .domain(data.map(d => d.metric))
                .range([0, chartHeight])
                .padding(0.2);

            const maxValue = d3.max(data, d => Math.max(d.district, d.state, d.national));
            const x = d3.scaleLinear()
                .domain([0, maxValue * 1.1])
                .range([0, chartWidth]);

            // Add Y axis
            chartGroup.append("g")
                .call(d3.axisLeft(y));

            // Add X axis
            chartGroup.append("g")
                .attr("transform", `translate(0,${chartHeight})`)
                .call(d3.axisBottom(x));

            const barHeight = y.bandwidth() / 3;

            // District bars
            chartGroup.selectAll(".district-bar")
                .data(data)
                .enter()
                .append("rect")
                .attr("class", "district-bar")
                .attr("x", 0)
                .attr("y", d => y(d.metric))
                .attr("width", d => x(d.district))
                .attr("height", barHeight)
                .attr("fill", "#4facfe");

            // State bars
            chartGroup.selectAll(".state-bar")
                .data(data)
                .enter()
                .append("rect")
                .attr("class", "state-bar")
                .attr("x", 0)
                .attr("y", d => y(d.metric) + barHeight)
                .attr("width", d => x(d.state))
                .attr("height", barHeight)
                .attr("fill", "#ff7f50");

            // National bars
            chartGroup.selectAll(".national-bar")
                .data(data)
                .enter()
                .append("rect")
                .attr("class", "national-bar")
                .attr("x", 0)
                .attr("y", d => y(d.metric) + barHeight * 2)
                .attr("width", d => x(d.national))
                .attr("height", barHeight)
                .attr("fill", "#98d8c8");

            // Add value labels
            chartGroup.selectAll(".district-label")
                .data(data)
                .enter()
                .append("text")
                .attr("class", "district-label bar-label")
                .attr("x", d => x(d.district) + 5)
                .attr("y", d => y(d.metric) + barHeight / 2)
                .attr("dy", "0.35em")
                .text(d => d.format(d.district));

            chartGroup.selectAll(".state-label")
                .data(data)
                .enter()
                .append("text")
                .attr("class", "state-label bar-label")
                .attr("x", d => x(d.state) + 5)
                .attr("y", d => y(d.metric) + barHeight * 1.5)
                .attr("dy", "0.35em")
                .text(d => d.format(d.state));

            chartGroup.selectAll(".national-label")
                .data(data)
                .enter()
                .append("text")
                .attr("class", "national-label bar-label")
                .attr("x", d => x(d.national) + 5)
                .attr("y", d => y(d.metric) + barHeight * 2.5)
                .attr("dy", "0.35em")
                .text(d => d.format(d.national));

            // Add legend
            const legend = chartGroup.append("g")
                .attr("transform", `translate(${chartWidth - 150}, 10)`);

            const legendData = [
                { color: "#4facfe", label: "District" },
                { color: "#ff7f50", label: "State Avg" },
                { color: "#98d8c8", label: "National Avg" }
            ];

            legendData.forEach((item, i) => {
                const legendRow = legend.append("g")
                    .attr("transform", `translate(0, ${i * 20})`);

                legendRow.append("rect")
                    .attr("width", 15)
                    .attr("height", 15)
                    .attr("fill", item.color);

                legendRow.append("text")
                    .attr("x", 20)
                    .attr("y", 12)
                    .style("font-size", "12px")
                    .text(item.label);
            });

            // Add chart title
            chartGroup.append("text")
                .attr("x", chartWidth / 2)
                .attr("y", -5)
                .attr("text-anchor", "middle")
                .style("font-size", "14px")
                .style("font-weight", "bold")
                .text(`${districtProps['District Name']} - Performance Comparison`);
        }

        function getTooltipContent(d) {
            const properties = d.properties;
            const formatNumber = d3.format(",");
            const formatPercent = d3.format(".1%");
            
            return `
                <strong>${properties.name}</strong><br>
                Revenue per Student: ${formatNumber(properties["Revenue per Student"] || 0)}<br>
                PSI Score: ${properties.PSI ? properties.PSI.toFixed(1) : 'N/A'}<br>
                Poverty Rate: ${formatPercent(properties["Poverty Share"] || 0)}<br>
            `;
        }

        function getDistrictTooltipContent(d) {
            const properties = d.properties;
            const formatNumber = d3.format(",");
            
            return `
                <strong>${properties['District Name']}</strong><br/>
                Revenue per Student: ${formatNumber(properties["Revenue per Student"] || 0)}<br/>
                Poverty Share: ${((properties["Share of school-age population (ages 5-17) in poverty"] || 0) * 100).toFixed(1)}%<br/>
                PSI: ${properties["PSI"] ? properties["PSI"].toFixed(1) : 'N/A'}<br/>
                Students: ${formatNumber(properties["Number of students attending school within the reporting local education agency"] || 0)}
            `;
        }
    </script>
</body>
</html>